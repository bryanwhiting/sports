---
title: "NBA Predictions"
description: |
  Comparing my models against FiveThirtyEight and some super-simple benchmarks
site: distill::distill_website
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
install.load::install_load('dplyr', 'tidyverse', 'ggplot2', 'leaflet', 'kableExtra', 'flexdashboard', 'shiny', 'magrittr', 'lubridate', 'formattable')
# Learn more about creating websites with Distill at:
# https://rstudio.github.io/distill/website.html

#ggthemes::palette_pander(8)
light_blue = "#56B4E9"
green = "#009E73"
green2 = "#00C073" # ppen apple Notes, cmd + shift + c for color pallete. I entered green, thens shifted the green slider right.
green3 = "#00DD73"
yellow = "#F0E442"
dk_blue = "#0072B2"
red = "#D55E00"
pink="#CC79A7"
gray ="#999999"
orange = "#E69F00"

css = paste0("background-color: ", dk_blue, "; color: #fff;")
```

Each day I challenge [FiveThirtyEight's Raptor](https://projects.fivethirtyeight.com/2020-nba-predictions/games/) predictions[^1].

[^1]: FiveThirtyEight's predictions are updated daily and can be downloaded here: https://projects.fivethirtyeight.com/nba-model/nba_elo_latest.csv.


## Today and Tomorrow's Games

The probabilities represent the home team's win probability.

```{r readin}

df = read_csv('../sports-predictions/output/all_scores.csv') %>%
  # ignore datetime - time zones mess things up anyway
  mutate(date = as_date(datetime)) %>%
  select(-datetime) %>%
  select(date, everything())

colnames(df) %<>% gsub('[.]*\\_prob1', '', .)
colnames(df) %<>% gsub('result\\_[.]*', '', .)

# Yesterday's Games
check = paste0('<font color="', green,'"><strong>âœ“</strong></font>')
df_yesterday = df %>% 
  filter(between(date, Sys.Date() -3, Sys.Date() - 1)) %>%
  mutate(
    indicator1 = ifelse(pg_score1 > pg_score2, check, ' '),
    indicator2 = ifelse(pg_score1 > pg_score2, ' ', check),
    game = paste0(indicator1, team1, ' (', pg_score1, ') | ', indicator2, team2, ' (', pg_score2, ')'),
    date = format(date, '%m-%d')
         ) %>%
  select(-team1, -team2, -starts_with('pg'), -season_week, -starts_with('indi')) %>%
  select(date, game, everything())

# Today's games
df_today = df %>% 
  filter(between(date, Sys.Date(), Sys.Date() + 1)) %>%
  select(-result, -starts_with('pg'), -season_week)
  

# Count number of games today for row packing
n_today = sum(df_today$date == Sys.Date())

date_today = paste(format(Sys.Date(), '%a, %b %d'), "| Probability Home Team Wins, Home vs. Away")
date_tom = format(Sys.Date() + 1, '%a, %b %d')

# Format the prediction columns with formattabl
p_cols = df_today %>% select(-team1, -team2, -date)

# TODO: https://www.displayr.com/formattable/
color_pred = function(x){
  # """ This works but not as well
  x = formattable::percent(x, digits=0)
  x = ifelse(x > 0.5,
         color_tile('transparent', green)(x * c(x > 0.5)),
         color_tile(red, 'transparent')(x * c(x < 0.5)))
  x
}

color_map = function(x){
  cell_spec(
      percent(x, 1), 
      color = "white", # font color
      bold = T,
      background = case_when(
        # x > 0.65 ~ green, 
        x > 0.65 ~ dk_blue, 
        # x < 0.65 & x >= 0.5 ~ green3,
        x < 0.65 & x >= 0.5 ~ light_blue,
        x < 0.5 & x >= 0.35 ~ orange,
        x < 0.35 ~ red,
        TRUE ~ gray,
        )
      )
}

# https://stackoverflow.com/a/54748839/2138773
df_today %>%
  select(-date) %>%
  mutate(
    game = paste(team1, 'vs', team2),
    elo = color_map(elo),
    `carm-elo` = color_map(`carm-elo`),
    raptor = color_map(raptor),
    v01 = color_map(v01),
    v02 = color_map(v02)
    ) %>%
  select(-team1, -team2) %>%
  select(game, everything()) %>%
  kable('html', escape=F) %>%
  kable_styling(c('striped', 'hover'), full_width = F) %>%
    pack_rows(date_today, 1, n_today, label_row_css = css) %>%
    pack_rows(date_tom, n_today+1, nrow(df_today), label_row_css = css) 
  
```

## Last Three Day's Predictions vs. Results

The probabilities represent the home team's win probabilty. Result = 0 if the home team lost, 1 if it won.

```{r last3}
# TODO: https://www.displayr.com/formattable/
# Get the green check for correct predictions - it's cool
# Then tally up at the bottom
# color_pred_correct <- function(result, p){
#   truth = (p > 0.5) & (result == 1)
#   p = formatter("span",
#       style = x ~ style(color = ifelse(truth, "green", "red")),
#       x ~ icontext(ifelse(truth, "ok", "remove"), ifelse(truth, p, p)))
#   return(p)
# }
# df_yesterday %>%
#   # mutate(
#   #   
#   # ) %>%
#   formattable(
#     list(
#       elo = formatter(
#         "span",
#         style = ~ style(color = ifelse((result == 1 & elo > 0.5) | (result == 0 & elo < 0.5), green, red)),
#         ~ icontext(ifelse((result == 1 & elo > 0.5) | (result == 0 & elo < 0.5), "ok", "remove"), percent(elo, 1))
#       )
#     )
#   ) #%>%
  # kable(escape=F, digits=3) %>%
  # kable_styling(c('striped', 'hover'), full_width = F)

# https://rstudio.github.io/DT/010-style.html
library(DT)
models = c('elo', 'v02')
mod_accs = c()
for (mod in models){
  mod_acc = paste0(mod, '_acc')
  r = df_yesterday$result
  m = df_yesterday[[mod]]
  df_yesterday[[mod_acc]] = as.numeric((r==0 & m < 0.5) | (r == 1 & m > 0.5)) 
  mod_accs = c(mod_accs, mod_acc)
}


total_sums = df_yesterday %>% select(!!mod_accs) %>% apply(2, sum)
sketch = htmltools::withTags(table(
  # tableHeader(c(')),
  tableFooter(c('', 'Total', total_sums))
))

dt <- df_yesterday %>%
  select(date, game, !!models, ends_with('_acc')) %>%
  datatable(style='default',
            escape=F,
            container=sketch,
            class = 'cell-border stripe',
            rownames=F,
            colnames = str_to_title(colnames(.)),
            options = 
              list(
                pageLength=100,
                dom = 'ft',
                columnDefs = list(
                  list(
                    className = 'dt-center', targets= 0:4
                  ),
                  list(
                    # Hide columns with _acc, this is zero-indexed (hence -1)
                    targets = which(colnames(.) %>% str_detect('_acc$')) - 1, 
                    visible = F
                  ))
              )) %>%
  formatPercentage(models) 
  # For every model to be shown, hide the _acc column and color the model col
for (mod in models){
  mod_acc = paste0(mod, '_acc')
  dt %<>% formatStyle(
    mod, mod_acc,
    color = 'white',
    fontWeight = 'bold',
    backgroundColor = styleEqual(c(0, 1), c(red, green))
  ) 
}
dt
```

## Seasonal Model Accuracy 
This section compares how accurate my models are with FiveThirtyEight's.

#### Up to Today
```{r accuracy}
# Todo: save out the index
df = read_csv('../sports-predictions/output/acc_overall.csv') %>% select(-index)
all = round(df[1,], 3)
all = all %>% select(home_overall, everything())
# min = .50; max=1
# g_home_freq = gauge(value = all$home_overall, min, max, label='Home')
# g_home_winpct = gauge(value = all$home_winpct, min, max)
# g_v01 = gauge(value = all$v01, min, max)
# g_elo = gauge(value = all$elo, min, max)
# g_home_freq
# fluidRow(
#   column(3,
#       g_home_freq, 
#   ),
#   column(3,
#       g_home_freq, 
#   ),
#   column(3,
#       g_home_freq, 
#   ),
#   column(3,
#       g_home_freq, 
#   )
# )


# TODO: https://haozhu233.github.io/kableExtra/awesome_table_in_html.html#integration_with_formattable
# add better cloring
colnames(all) = c("Win Rate", "Home %", "Home % > Away %", "v01", "elo", "carm-elo", "raptor")
all %>%
  t() %>%
  # as.data.frame() %>%
  # mutate(V1 = scales::percent(V1,accuracy=.1)) %>%
  # rename(` ` = V1) 
  kable() %>%
  kable_styling(c('striped', 'hover'), full_width = F) %>%
  pack_rows("Home Team Benchmarks", 1,3, label_row_css = css) %>%
  pack_rows("My Models", 4, 5, label_row_css = css) %>%
  pack_rows("Five Thirty Eight", 6, ncol(all), label_row_css = css)
  # add_header_above(c("Home Team Benchmarks" = 3, "My Model"=1, "538" = 3))
  
```

* Win Rate: How often does the home team win?
* Home %: How often does the home team win when its win % before the game was more than 50%? (A home team with a record of 53% is predicted to win, butwith a record of 49% is predicted to lose.)
* Home % > Away %: If the home team's win % is greater than away team's win %, the home team is predicted to win. Otherwise, they're predicted to lose. E.g., if home win % = 0.39 and away win% = 0.40, I predict the away team will win.
* v01: I build my own model.
* V02: Version 2 of my model.

#### Model Calibration

How well do the model's predictions align with true probabilities? A prediction of 70% should win 70% of the time. You'd expect that if the model probability ranges between 40-50%, the home team should win 40-50% of the time. If the model probability ranges between 90%-100%, you'd expect the home team to win 90-100% of the time. Black line represents true probability

```{r calib}
df = read_csv('../sports-predictions/output/acc_overall.csv') %>% 
  select( -home_overall, -home_vs_away_winpct) %>%
  rename(score_range = index)

# TODO: this isn't a true calibration plot. 
# This chart should show wether the model point is between 0.80and 0.90,
# Does the interval capture the probability?
df %>% 
  filter(score_range != 'all') %>%
  mutate(prob_range = row_number()/10) %>% # - 0.05
  select(-score_range) %>%
  gather(model, avg_prob, -prob_range) %>%
  ggplot(aes(x = prob_range, y = avg_prob, color = model)) + 
  geom_line() + 
  geom_point() + 
  geom_abline(intercept = 0, slope=1, linetype=2, color='gray') + 
  geom_abline(intercept = -0.05, slope=1, linetype=1, color='gray') + 
  geom_abline(intercept = -0.1, slope=1, linetype=2, color='gray') + 
  ggthemes::scale_color_pander() +
  scale_x_continuous(breaks = seq(from = 0, to = 1, by = 0.2)) + 
  scale_y_continuous(breaks = seq(from = 0, to = 1, by = 0.2)) + 
  theme_minimal() +
  labs(title = 'Probability Calibration Plot',
       subtitle = 'How much do the model align with true probabilities?',
       x = 'Probability Score Range (0.1 = from 0.0-0.1)',
       y = 'Frequency of Home Team Win (Within Prob Range)')
```

#### Model Accuracy By Week
```{r accwithin}
plot_acc_by_week <- function(df, title, subtitle){
  
  df %>%
    rename(`Home %` = home_winpct) %>%
    gather(model, accuracy, -season_week) %>%
    ggplot(aes(x=season_week, y = accuracy, color = model)) +
    geom_line() +
    geom_point() + 
    geom_hline(yintercept=.5) +
    ggthemes::scale_color_pander() + 
    theme_minimal() + 
    labs(title=title,
         subtitle=subtitle,
         x = 'Season Week',
         y = "Model Accuracy",
         caption = 'Source: FiveThirtyEight.com')
}

df = read_csv('../sports-predictions/output/acc_within_week.csv')
colnames(df) %<>% gsub('acc_pred_[.]*', '', .)
plot_acc_by_week(df, title = 'Accuracy of Model Within Season Week',
                 subtitle = 'A score of .67 at week 5 is the accuracy of the model for all games within week 5.')

```

```{r accupto}
df = read_csv('../sports-predictions/output/acc_upto_week.csv')
colnames(df) %<>% gsub('acc_pred_[.]*', '', .)
plot_acc_by_week(df, title = 'Accuracy of Model Up To Season Week',
                 subtitle = 'A score of .67 at week 5 is the accuracy of the model for all games from week 1-5.')
```

```{r accsince}
df = read_csv('../sports-predictions/output/acc_since_week.csv')
colnames(df) %<>% gsub('acc_pred_[.]*', '', .)
plot_acc_by_week(df, title = 'Accuracy of Model Since Season Week',
                 subtitle = 'A score of .67 at week 5 is the accuracy of the model for all games from week 5-X, where X is today\'s week.')
```



